{% extends "base.html" %}
{% block title %}My Bookings{% endblock %}
{% block content %}
<div class="flex justify-between items-center mb-8">
  <div>
    <h1 class="text-4xl font-extrabold text-gray-800">My Bookings ğŸš—</h1>
    <p class="text-gray-500 mt-1">Hello, {{ user.username }}!</p>
  </div>
  <div class="flex gap-3">
    <a href="{% url 'vehicle_list' %}"
       class="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:-translate-y-0.5">
      ğŸš— My Vehicles
    </a>
    <a href="{% url 'parking_list' %}"
       class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:-translate-y-0.5">
      ğŸ” Find Parking
    </a>
  </div>
</div>

{% if reservations %}
<div class="space-y-4">
  {% for res in reservations %}
  <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">

    <!-- Top Bar -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 flex justify-between items-center">
      <p class="font-bold">Booking #{{ res.id }}</p>
      <span class="px-3 py-1 rounded-full text-xs font-bold bg-white/20">
        {{ res.status }}
      </span>
    </div>

    <!-- Booking Details -->
    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- Slot & Lot Info -->
      <div>
        <p class="text-xs text-gray-400 uppercase font-semibold mb-2">ğŸ“ Location</p>
        <p class="font-bold text-gray-800 text-lg">{{ res.slot.lot.name }}</p>
        <p class="text-gray-500 text-sm mt-1">{{ res.slot.lot.address }}</p>
        <p class="text-gray-500 text-sm">{{ res.slot.lot.city }}</p>
        <div class="mt-2 flex gap-2">
          <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-semibold">
            Slot {{ res.slot.slot_number }}
          </span>
          <span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full font-semibold">
            {{ res.slot.slot_type }}
          </span>
        </div>
      </div>

      <!-- Time Info -->
      <div>
        <p class="text-xs text-gray-400 uppercase font-semibold mb-2">ğŸ• Time</p>
        <div class="space-y-2">
          <div class="bg-green-50 rounded-xl p-3">
            <p class="text-xs text-green-600 font-semibold">Check In</p>
            <p class="font-bold text-gray-800">{{ res.start_time|date:"M d, Y" }}</p>
            <p class="text-gray-600 text-sm">{{ res.start_time|date:"H:i" }}</p>
          </div>
          <div class="bg-red-50 rounded-xl p-3">
            <p class="text-xs text-red-600 font-semibold">Check Out</p>
            <p class="font-bold text-gray-800">{{ res.end_time|date:"M d, Y" }}</p>
            <p class="text-gray-600 text-sm">{{ res.end_time|date:"H:i" }}</p>
          </div>
        </div>
      </div>

      <!-- Vehicle & Payment Info -->
      <div>
        <p class="text-xs text-gray-400 uppercase font-semibold mb-2">ğŸš— Vehicle & Payment</p>
        {% if res.vehicle %}
        <div class="bg-gray-50 rounded-xl p-3 mb-3">
          <p class="text-xs text-gray-500">Vehicle</p>
          <p class="font-bold text-gray-800">{{ res.vehicle.plate_number }}</p>
          <p class="text-gray-500 text-sm">{{ res.vehicle.vehicle_type }}</p>
        </div>
        {% endif %}
        <div class="bg-yellow-50 rounded-xl p-3">
          <p class="text-xs text-yellow-600">Total Amount</p>
          <p class="text-2xl font-extrabold text-yellow-600">â‚¹{{ res.total_amount }}</p>
          <p class="text-xs text-gray-400 mt-1">â‚¹{{ res.slot.hourly_rate }}/hr</p>
        </div>

        {% if res.status == 'PENDING' %}
        <a href="{% url 'payment' res.id %}"
           class="mt-3 block text-center bg-gradient-to-r from-green-500 to-emerald-600 text-white py-2 rounded-xl font-bold hover:shadow transition">
          ğŸ’³ Pay Now
        </a>
        {% endif %}
      </div>

    </div>
    {% if res.payment %}
<div class="bg-gray-50 rounded-xl p-3 mt-2">
  <p class="text-xs text-gray-400">Transaction ID</p>
  <p class="font-bold text-gray-700 tracking-wider text-sm">
    {{ res.payment.transaction_id }}
  </p>
  <p class="text-xs text-gray-400 mt-1">
    Paid: {{ res.payment.paid_at|date:"M d, Y H:i" }}
  </p>
</div>
{% endif %}

    <!-- Owner Contact Footer -->
    <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-between items-center">
      <p class="text-sm text-gray-500">
        ğŸ¢ Owned by: <strong>{{ res.slot.lot.owner.username }}</strong>
      </p>
      <p class="text-xs text-gray-400">Booked on {{ res.created_at|date:"M d, Y H:i" }}</p>
    </div>

  </div>
  {% endfor %}
</div>

{% else %}
<div class="bg-white rounded-2xl shadow p-12 text-center border border-gray-100">
  <div class="text-5xl mb-4">ğŸ“­</div>
  <h3 class="text-xl font-bold text-gray-600 mb-2">No Bookings Yet</h3>
  <p class="text-gray-400">When you book a slot, your bookings will appear here.</p>
</div>
{% endif %}

{% endblock %}

<script>
  // Get current date and time in the format datetime-local needs
  function getCurrentDateTimeLocal() {
    const now = new Date();
    // Add 5 minutes buffer so user has time to fill the form
    now.setMinutes(now.getMinutes() + 5);
    // Format: YYYY-MM-DDTHH:MM
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const mins = String(now.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${mins}`;
  }

  const startInput = document.querySelector('input[name="start_time"]');
  const endInput = document.querySelector('input[name="end_time"]');
  const minDateTime = getCurrentDateTimeLocal();

  // âœ… Prevent past time selection from the calendar itself
  startInput.min = minDateTime;
  endInput.min = minDateTime;

  // âœ… When start time is picked, end time minimum updates automatically
  startInput.addEventListener('change', function () {
    // End time must be at least 30 mins after start time
    const start = new Date(this.value);
    start.setMinutes(start.getMinutes() + 30);
    const year = start.getFullYear();
    const month = String(start.getMonth() + 1).padStart(2, '0');
    const day = String(start.getDate()).padStart(2, '0');
    const hours = String(start.getHours()).padStart(2, '0');
    const mins = String(start.getMinutes()).padStart(2, '0');
    endInput.min = `${year}-${month}-${day}T${hours}:${mins}`;

    // Clear end time if it's now invalid
    if (endInput.value && endInput.value < endInput.min) {
      endInput.value = '';
    }

    calculateAmount();
  });

  endInput.addEventListener('change', calculateAmount);
</script>
